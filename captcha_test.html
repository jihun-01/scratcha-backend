<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>캡챠 테스트 (순수 JS)</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                background-color: #f4f4f4;
                margin: 0;
            }
            .container {
                background-color: #fff;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                max-width: 500px;
                width: 100%;
                text-align: center;
            }
            img {
                max-width: 100%;
                height: auto;
                border: 1px solid #eee;
                border-radius: 4px;
                margin-top: 15px;
                margin-bottom: 15px;
            }
            ul {
                list-style: none;
                padding: 0;
            }
            li {
                background-color: #e9e9e9;
                margin: 5px 0;
                padding: 10px;
                border-radius: 4px;
                cursor: pointer; /* 선택지 클릭 가능하도록 */
            }
            li:hover {
                background-color: #dcdcdc;
            }
            .loading,
            .error {
                font-weight: bold;
                color: #007bff;
            }
            .error {
                color: #dc3545;
            }
            .result-success {
                color: #28a745;
                font-weight: bold;
            }
            .result-fail,
            .result-timeout {
                color: #dc3545;
                font-weight: bold;
            }
            .copy-group {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
                margin-bottom: 10px;
            }
            .copy-group button {
                padding: 5px 10px;
                background-color: #6c757d;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.8em;
            }
            .copy-group button:hover {
                background-color: #5a6268;
            }
            .copy-message {
                font-size: 0.8em;
                color: #28a745;
                margin-left: 5px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h2>캡챠 테스트</h2>
            <div id="status" class="loading">캡챠 문제 로딩 중...</div>
            <div id="captcha-content" style="display: none">
                <div class="copy-group">
                    <p><strong>클라이언트 토큰:</strong> <span id="client-token"></span></p>
                    <button id="copy-token-button">복사</button>
                    <span id="copy-message" class="copy-message"></span>
                </div>
                <p><strong>프롬프트:</strong> <span id="prompt"></span></p>
                <p><strong>캡챠 이미지:</strong></p>
                <img id="captcha-image" src="" alt="캡챠 이미지" />
                <p><strong>선택지:</strong></p>
                <ul id="options-list"></ul>

                <div id="verification-result" style="margin-top: 15px"></div>
            </div>
        </div>

        <script>
            // TODO: 실제 API 서버 주소와 API 키로 변경해주세요.
            //const API_BASE_URL = "https://api.scratcha.cloud"; // FastAPI 서버 주소
            const API_BASE_URL = "http://localhost:8001";
            const API_KEY = "fa10a7e22508cfc50fd4392d2e88c5f5ee3c4d047575970db5a374a20a56e3b4"; // 유효한 X-Api-Key

            const statusDiv = document.getElementById("status");
            const captchaContentDiv = document.getElementById("captcha-content");
            const clientTokenSpan = document.getElementById("client-token");
            const copyTokenButton = document.getElementById("copy-token-button");
            const copyMessageSpan = document.getElementById("copy-message");
            const promptSpan = document.getElementById("prompt");
            const captchaImage = document.getElementById("captcha-image");
            const optionsList = document.getElementById("options-list");
            const verificationResultDiv = document.getElementById("verification-result");

            let currentClientToken = null; // 현재 캡챠의 clientToken을 저장

            async function fetchCaptchaProblem() {
                try {
                    statusDiv.textContent = "캡챠 문제 로딩 중...";
                    statusDiv.className = "loading";
                    captchaContentDiv.style.display = "none";
                    verificationResultDiv.textContent = ""; // 이전 결과 초기화
                    copyMessageSpan.textContent = ""; // 복사 메시지 초기화

                    // 1단계: 캡챠 문제 요청 (POST /api/captcha/problem)
                    const response = await fetch(`${API_BASE_URL}/api/captcha/problem`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-Api-Key": API_KEY, // API 키 헤더에 포함
                        },
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(
                            `HTTP error! status: ${response.status}, detail: ${errorData.detail || response.statusText}`
                        );
                    }

                    const data = await response.json();
                    console.log("Received Captcha Problem:", data);

                    // 데이터 표시
                    currentClientToken = data.clientToken; // clientToken 저장
                    clientTokenSpan.textContent = data.clientToken;
                    promptSpan.textContent = data.prompt;

                    // 2단계: 이미지 로딩 (GET /api/captcha/image/{problem_id})
                    if (data.imageUrl) {
                        captchaImage.src = data.imageUrl;
                    } else {
                        captchaImage.alt = "이미지 URL을 찾을 수 없습니다.";
                    }

                    optionsList.innerHTML = ""; // 기존 선택지 초기화
                    data.options.forEach((option) => {
                        const li = document.createElement("li");
                        li.textContent = option;
                        // 선택지 클릭 시 정답 입력 및 자동 제출
                        li.onclick = async () => {
                            await submitCaptchaAnswer(option); // 정답 제출 함수 호출
                        };
                        optionsList.appendChild(li);
                    });

                    statusDiv.style.display = "none"; // 로딩 메시지 숨김
                    captchaContentDiv.style.display = "block"; // 캡챠 내용 표시
                } catch (e) {
                    console.error("Error fetching captcha problem:", e);
                    statusDiv.textContent = `오류 발생: ${e.message}`;
                    statusDiv.className = "error";
                    statusDiv.style.display = "block";
                    captchaContentDiv.style.display = "none";
                }
            }

            async function submitCaptchaAnswer(userAnswer) {
                if (!currentClientToken) {
                    verificationResultDiv.textContent = "클라이언트 토큰이 없습니다. 캡챠를 먼저 로드해주세요.";
                    verificationResultDiv.className = "result-fail";
                    return;
                }

                if (!userAnswer) {
                    verificationResultDiv.textContent = "정답을 입력해주세요.";
                    verificationResultDiv.className = "result-fail";
                    return;
                }

                verificationResultDiv.textContent = "정답 제출 중...";
                verificationResultDiv.className = "loading";

                try {
                    // 3단계: 캡챠 정답 검증 (POST /api/captcha/verify)
                    const response = await fetch(`${API_BASE_URL}/api/captcha/verify`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-Client-Token": currentClientToken, // clientToken을 헤더에 포함
                        },
                        body: JSON.stringify({ answer: userAnswer }), // 정답만 본문에 포함
                    });

                    const resultData = await response.json();
                    console.log("Verification Result:", resultData);

                    verificationResultDiv.textContent = `결과: ${resultData.result.toUpperCase()} - ${
                        resultData.message
                    }`;
                    verificationResultDiv.className = `result-${resultData.result}`; // 결과에 따라 클래스 변경

                    // 검증 후 새 캡챠 로드 (선택 사항: 성공/실패 여부와 관계없이 새 캡챠 로드)
                    setTimeout(fetchCaptchaProblem, 1500); // 1.5초 후 새 캡챠 로드
                } catch (e) {
                    console.error("Error submitting answer:", e);
                    verificationResultDiv.textContent = `검증 중 오류 발생: ${e.message}`;
                    verificationResultDiv.className = "error";
                } finally {
                    // submitButton.disabled = false; // 제출 버튼 다시 활성화 (삭제되었으므로 필요 없음)
                }
            }

            // 이벤트 리스너 연결
            document.addEventListener("DOMContentLoaded", fetchCaptchaProblem);
            // submitButton.addEventListener("click", submitCaptchaAnswer); // 제출 버튼 삭제되었으므로 필요 없음
            // 엔터 키로 제출 (텍스트 입력 필드 삭제되었으므로 필요 없음)
            // answerInput.addEventListener("keypress", (event) => {
            //     if (event.key === "Enter") {
            //         submitCaptchaAnswer();
            //     }
            // });

            // 클라이언트 토큰 복사 버튼 이벤트 리스너
            copyTokenButton.addEventListener("click", async () => {
                try {
                    await navigator.clipboard.writeText(clientTokenSpan.textContent);
                    copyMessageSpan.textContent = "복사됨!";
                    setTimeout(() => {
                        copyMessageSpan.textContent = "";
                    }, 1500); // 1.5초 후 메시지 사라짐
                } catch (err) {
                    console.error("클립보드 복사 실패:", err);
                    copyMessageSpan.textContent = "복사 실패!";
                    copyMessageSpan.style.color = "red";
                    setTimeout(() => {
                        copyMessageSpan.textContent = "";
                        copyMessageSpan.style.color = "";
                    }, 1500);
                }
            });
        </script>
    </body>
</html>
